# Data Model: RAG Chatbot for Physical AI Book

**Feature**: RAG Chatbot for Physical AI Book
**Date**: 2025-12-20
**Branch**: 1-rag-chatbot-physical-ai

## Overview

This document defines the data models for the RAG chatbot system. The models are designed to support retrieval-augmented generation while maintaining privacy and operating within free-tier constraints.

## Entity Models

### BookContentChunk

Represents a chunk of the Physical AI book content that has been processed for embedding and retrieval.

- **id** (string): Unique identifier for the chunk
- **content** (text): The actual text content of the chunk
- **title** (string): Title or heading of the section this chunk belongs to
- **section** (string): Book section identifier (e.g., "Chapter 3", "Section 2.1")
- **page_number** (integer): Page number in the original book
- **embedding_vector** (vector): Vector representation of the content for similarity search
- **metadata** (json): Additional metadata about the content (tags, concepts, etc.)
- **created_at** (datetime): Timestamp when the chunk was created
- **updated_at** (datetime): Timestamp when the chunk was last updated

**Relationships**:
- Belongs to a BookDocument

**Validation rules**:
- content must not exceed 1000 tokens
- embedding_vector must be generated by Cohere embed-english-v3.0 model

### BookDocument

Represents the entire Physical AI book as a document entity.

- **id** (string): Unique identifier for the document
- **title** (string): Title of the book
- **author** (string): Author of the book
- **version** (string): Version of the book content
- **total_chunks** (integer): Number of chunks the book is divided into
- **embedding_model** (string): Model used for generating embeddings
- **created_at** (datetime): Timestamp when the document was processed
- **updated_at** (datetime): Timestamp when the document was last updated

**Relationships**:
- Has many BookContentChunks

### Query

Represents a user query to the system. Note: This is for metadata tracking only, actual query text is not stored for privacy.

- **id** (string): Unique identifier for the query session
- **session_id** (string): Session identifier (temporary, not persisted)
- **selected_text** (text): Text selected by user on the page (if any)
- **query_embedding** (vector): Vector representation of the user's query
- **response_id** (string): Reference to the response generated
- **timestamp** (datetime): When the query was made
- **user_agent** (string): Anonymized user agent string (optional)
- **ip_hash** (string): Hashed IP for rate limiting (not stored in logs)

**Validation rules**:
- selected_text must not exceed 500 tokens
- query_embedding must be generated by Cohere embed-english-v3.0 model
- No actual query text is stored for privacy compliance

### Response

Represents a response generated by the system. Note: This is for metadata tracking only, actual response text is not stored for privacy.

- **id** (string): Unique identifier for the response
- **query_id** (string): Reference to the associated query
- **response_chunks** (array): IDs of book content chunks used to generate response
- **confidence_score** (float): Confidence score of the response (0.0-1.0)
- **timestamp** (datetime): When the response was generated
- **response_time_ms** (integer): Time taken to generate the response

**Validation rules**:
- No actual response text is stored for privacy compliance
- response_chunks must reference valid BookContentChunks

## State Transitions

### Query Processing Flow

1. **QueryReceived**: Query entity is created with session_id and selected_text
2. **EmbeddingGenerated**: query_embedding is created from user query
3. **ContextRetrieved**: Relevant BookContentChunks are identified via similarity search
4. **ResponseGenerated**: Response is created with references to used chunks
5. **ResponseDelivered**: Response is sent to user and temporary session data is cleared

## Database Schema Considerations

### Neon Postgres Tables

```sql
-- Table for book content chunks
CREATE TABLE book_content_chunks (
  id TEXT PRIMARY KEY,
  content TEXT NOT NULL,
  title TEXT NOT NULL,
  section TEXT,
  page_number INTEGER,
  embedding_vector vector(1024), -- Adjust dimension based on Cohere model
  metadata JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Table for book documents
CREATE TABLE book_documents (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  author TEXT NOT NULL,
  version TEXT,
  total_chunks INTEGER,
  embedding_model TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes for efficient retrieval
CREATE INDEX idx_book_content_chunks_embedding ON book_content_chunks USING ivfflat (embedding_vector vector_cosine_ops);
CREATE INDEX idx_book_content_chunks_section ON book_content_chunks (section);
```

### Qdrant Collection Schema

```json
{
  "collection_name": "book_content_chunks",
  "vector_size": 1024, // Adjust based on Cohere embedding model
  "distance": "Cosine",
  "payload_schema": {
    "content_id": "keyword",
    "title": "keyword",
    "section": "keyword",
    "page_number": "integer"
  }
}
```

## Privacy Considerations

All data models are designed with privacy in mind:
- No user queries or responses are stored persistently
- Session data is temporary and cleared after use
- Personal information is not collected or stored
- IP addresses are only used for rate limiting as hashed values